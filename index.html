<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kemopetrol Gig Archive</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #0b0b0c;
    color: #e0e0e0;
    margin: 0;
    padding: 20px;
  }
  h1 {
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
  }
  .title-line {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 2em;
    font-weight: bold;
  }
  .logo-inline {
    height: 1em;
    vertical-align: middle;
  }
  .subtitle {
    font-size: 1.2em;
    font-weight: normal;
  }
  .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
    justify-content: center;
  }
  input, select, button {
    padding: 6px;
    font-size: 14px;
  }
  .table-container {
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px;
  }
  th, td {
    padding: 8px;
    border-bottom: 1px solid #444;
    text-align: left;
    white-space: nowrap;
  }
  th {
    background-color: #1a1a1a;
  }
  .num {
    text-align: right;
    width: 3ch;
  }
</style>
</head>
<body>

<h1>
  <span class="title-line">
    Kemopetrol
    <img src="kemopetrol_logo_optimized.png" alt="Kemopetrol logo" class="logo-inline">
  </span>
  <span class="subtitle">Gig Archive</span>
</h1>

<div class="filters">
  <input type="text" id="search" placeholder="Search...">
  <select id="yearFilter">
    <option value="">All years</option>
  </select>
  <select id="venueFilter">
    <option value="">All venues / events</option>
  </select>
  <select id="cityFilter">
    <option value="">All cities</option>
  </select>
  <select id="countryFilter">
    <option value="">All countries</option>
  </select>
  <button id="toggleOrder">Toggle order</button>
</div>

<div class="table-container">
<table id="gigTable">
  <thead>
    <tr>
      <th>#</th>
      <th>Date</th>
      <th>Venue / Event</th>
      <th>City</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
</div>

<p>Total gigs: <span id="totalCount"></span></p>

<script src="gigs.js" defer></script>
<script defer>
document.addEventListener('DOMContentLoaded', function () {
  const gigs = (window.gigs || []).slice();

  const tbody         = document.querySelector('#gigTable tbody');
  const yearFilter    = document.getElementById('yearFilter');
  const venueFilter   = document.getElementById('venueFilter');
  const cityFilter    = document.getElementById('cityFilter');
  const countryFilter = document.getElementById('countryFilter');
  const searchInput   = document.getElementById('search');
  const totalCountEl  = document.getElementById('totalCount');
  const toggleOrderBtn= document.getElementById('toggleOrder');

  function normalizeVenue(name){
    const original = (name || '').trim();
    const aliases = [
      { re:/tavastia/i,              name:'Tavastia' },
      { re:/apollo/i,                name:'Apollo' },
      { re:/midnight\s*party\s*planet/i, name:'Midnight Party Planet' },
      { re:/provinssi/i,              name:'Provinssi' },
      { re:/kaapelitehdas/i,          name:'Kaapelitehdas' },
    ];
    for (const a of aliases) {
      if (a.re.test(original)) return a.name;
    }
    return original;
  }

  let sortDir = localStorage.getItem('kemopetrol_sort_dir') || 'desc';
  function updateToggleLabel(){
    toggleOrderBtn.textContent = (sortDir === 'desc') ? 'Newest first ▼' : 'Oldest first ▲';
  }
  updateToggleLabel();

  function parseDate(str){
    const [d,m,y] = str.split(".");
    return new Date(`${y}-${m}-${d}T00:00:00`);
  }
  function getSorted(data){
    const copy = data.slice().sort((a,b)=>parseDate(a.date)-parseDate(b.date));
    if (sortDir === 'desc') copy.reverse();
    return copy;
  }

  function applyFilters(data){
    const s  = (searchInput?.value || '').toLowerCase();
    const yf = yearFilter?.value || '';
    const vf = venueFilter?.value || '';
    const cf = cityFilter?.value || '';
    const cof= countryFilter?.value || '';

    return data.filter(g =>
      (!yf || g.date.endsWith(yf)) &&
      (!vf || normalizeVenue(g.venue).toLowerCase() === vf.toLowerCase()) &&
      (!cf || g.city === cf) &&
      (!cof || g.country === cof) &&
      (
        g.date.toLowerCase().includes(s) ||
        g.venue.toLowerCase().includes(s) ||
        g.city.toLowerCase().includes(s) ||
        g.country.toLowerCase().includes(s)
      )
    );
  }

  function renderTable(rows){
    tbody.innerHTML = '';
    rows.forEach((g, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="num">${idx + 1}</td>
        <td>${g.date}</td>
        <td>${g.venue}</td>
        <td>${g.city}</td>
        <td>${g.country}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function render(){
    const sorted   = getSorted(gigs);
    const filtered = applyFilters(sorted);
    totalCountEl.textContent = filtered.length;
    renderTable(filtered);
  }

  function addOptions(selectEl, values) {
    const frag = document.createDocumentFragment();
    values.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      frag.appendChild(opt);
    });
    selectEl.appendChild(frag);
  }

  const years  = [...new Set(gigs.map(g => g.date.split(".")[2]))].sort((a,b)=>b-a);
  addOptions(yearFilter, years);

  const venues = [...new Set(gigs.map(g => normalizeVenue(g.venue)))].sort();
  addOptions(venueFilter, venues);

  const cities = [...new Set(gigs.map(g => g.city))].sort();
  addOptions(cityFilter, cities);

  const countries = [...new Set(gigs.map(g => g.country))].sort();
  addOptions(countryFilter, countries);

  searchInput.addEventListener('input', render);
  yearFilter.addEventListener('change', render);
  venueFilter.addEventListener('change', render);
  cityFilter.addEventListener('change', render);
  countryFilter.addEventListener('change', render);
  toggleOrderBtn.addEventListener('click', () => {
    sortDir = (sortDir === 'desc') ? 'asc' : 'desc';
    localStorage.setItem('kemopetrol_sort_dir', sortDir);
    updateToggleLabel();
    render();
  });

  render();
});
</script>

</body>
</html>
