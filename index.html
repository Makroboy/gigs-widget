<script src="gigs.js"></script>
<script>
(function(){
  const gigs = window.gigs.slice(); // käytetään kopiota
  const tbody = document.querySelector('#gigTable tbody');
  const yearFilter = document.getElementById('yearFilter');
  const venueFilter = document.getElementById('venueFilter');
  const cityFilter = document.getElementById('cityFilter');
  const countryFilter = document.getElementById('countryFilter');
  const searchInput = document.getElementById('search');
  const totalCountEl = document.getElementById('totalCount') || document.getElementById('gigCount');
  const groupBy = document.getElementById('groupBy');
  const limitBy = document.getElementById('limitBy');
  const groupList = document.getElementById('groupList');
  const toggleOrderBtn = document.getElementById('toggleOrder');

  // --- VENUE NORMALISOINTI RYHMITTELYÄ VARTEN ---
  function normalizeVenue(name){
    const original = (name || '').trim();

    // 1) Jos on pilkkuja, käytä viimeistä osaa (esim. "Ruma-klubi, Tavastia" → "Tavastia")
    const parts = original.split(',').map(p => p.trim()).filter(Boolean);
    let s = parts.length > 1 ? parts[parts.length - 1] : original;

    // 2) Alias-säännöt (laajennettavissa)
    const aliases = [
      // Täsmäyksiä yleisiin kirjoitusvariaatioihin
      { re: /tavastia(-?klubi)?/i,              name: 'Tavastia' },
      { re: /yo[\-\s]?talo/i,                   name: 'Yo-talo' },
      { re: /henry'?s\s*pub/i,                  name: "Henry's Pub" },
      { re: /kåren/i,                           name: 'Kåren' },
      { re: /nosturi/i,                         name: 'Nosturi' },
      { re: /dbtl/i,                            name: 'DBTL' },
      { re: /kerubi/i,                          name: 'Kerubi' },
      { re: /lutakko/i,                         name: 'Lutakko' },
      { re: /virgin\s*oil/i,                    name: 'Virgin Oil Co.' },
      { re: /\bklubi\b$/i,                      name: 'Klubi' },

      // --- Uudet niputukset toiveidesi mukaan ---
      // Apollo Live Club / Apollo
      { re: /apollo(\s*live\s*club)?$/i,        name: 'Apollo' },

      // Midnight Party Planet (myös Tykkimäki- jne. perässä)
      { re: /midnight\s*party\s*planet/i,       name: 'Midnight Party Planet' },

      // Provinssi / Provinssirock / Provinssi-rock ym.
      { re: /provinssi(\s*-?\s*rock|rock)?/i,   name: 'Provinssi' },

      // Kaapelitehdas / Cable Factory
      { re: /(kaapelitehdas|cable\s*factory)/i, name: 'Kaapelitehdas' },
    ];

    for (const a of aliases) {
      if (a.re.test(original) || a.re.test(s)) return a.name;
    }
    return s;
  }
  // --------------------------------------------------

  // Järjestyksen tila (localStorage)
  let sortDir = localStorage.getItem('kemopetrol_sort_dir') || 'desc'; // desc = newest first
  function updateToggleLabel(){
    if (!toggleOrderBtn) return;
    toggleOrderBtn.textContent = (sortDir === 'desc') ? 'Newest first ▼' : 'Oldest first ▲';
  }
  updateToggleLabel();

  // Suodatinlistat
  const years = [...new Set(gigs.map(g => g.date.split(".")[2]))].sort((a,b) => b-a);
  years.forEach(y => { const o=document.createElement('option'); o.value=y; o.textContent=y; yearFilter.appendChild(o); });
  const venues = [...new Set(gigs.map(g => g.venue))].sort();
  venues.forEach(v => { const o=document.createElement('option'); o.value=v; o.textContent=v; venueFilter.appendChild(o); });
  const cities = [...new Set(gigs.map(g => g.city))].sort();
  cities.forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; cityFilter.appendChild(o); });
  const countries = [...new Set(gigs.map(g => g.country))].sort();
  countries.forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; countryFilter.appendChild(o); });

  function parseDate(str){
    const [d,m,y] = str.split(".");
    return new Date(`${y}-${m}-${d}T00:00:00`);
  }
  function getSorted(data){
    const copy = data.slice().sort((a,b) => parseDate(a.date) - parseDate(b.date)); // oldest->newest
    if (sortDir === 'desc') copy.reverse(); // newest->oldest
    return copy;
  }

  function applyFilters(data){
    const s = searchInput.value.toLowerCase();
    const yf = yearFilter.value, vf = venueFilter.value, cf = cityFilter.value, cof = countryFilter.value;

    return data.filter(g =>
      (!yf || g.date.endsWith(yf)) &&
      (!vf || g.venue.toLowerCase().includes(vf.toLowerCase())) &&  // VENUE: osittainen osuma
      (!cf || g.city === cf) &&
      (!cof || g.country === cof) &&
      (
        g.date.toLowerCase().includes(s) ||
        g.venue.toLowerCase().includes(s) ||
        g.city.toLowerCase().includes(s) ||
        g.country.toLowerCase().includes(s)
      )
    );
  }

  function renderTable(rows){
    tbody.innerHTML = '';
    rows.forEach((g, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="num">${idx + 1}</td>
        <td>${g.date}</td>
        <td>${g.venue}</td>
        <td>${g.city}</td>
        <td>${g.country}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderGrouping(rows){
    if (!groupBy || !groupList) return;
    const key = groupBy.value;
    groupList.innerHTML = '';
    if(!key){ return; }

    const getKey = (g) => {
      if (key === 'year') return g.date.split(".")[2];
      if (key === 'venue') return normalizeVenue(g.venue); // <-- käytä normalisoitua venuea
      return g[key];
    };

    const counts = {};
    rows.forEach(g => {
      const k = getKey(g) || '(unknown)';
      counts[k] = (counts[k] || 0) + 1;
    });

    const items = Object.entries(counts)
      .sort((a,b) => b[1] - a[1] || (''+a[0]).localeCompare(''+b[0]));

    const limSel = document.getElementById('limitBy');
    const limit = (limSel && limSel.value === 'all') ? items.length : parseInt((limSel ? limSel.value : '10'), 10);

    groupList.innerHTML = '';
    items.slice(0, limit).forEach(([name, count]) => {
      const li = document.createElement('li');
      li.textContent = `${name}: ${count}`;
      groupList.appendChild(li);
    });
  }

  function render(){
    const sorted = getSorted(gigs);
    const filtered = applyFilters(sorted);
    if (totalCountEl) totalCountEl.textContent = filtered.length;
    renderTable(filtered);
    renderGrouping(filtered);
  }

  // Tapahtumat
  searchInput.addEventListener('input', render);
  [yearFilter, venueFilter, cityFilter, countryFilter, groupBy, limitBy].forEach(el => el && el.addEventListener('change', render));
  if (toggleOrderBtn) {
    toggleOrderBtn.addEventListener('click', () => {
      sortDir = (sortDir === 'desc') ? 'asc' : 'desc';
      localStorage.setItem('kemopetrol_sort_dir', sortDir);
      updateToggleLabel();
      render();
    });
  }

  render();
})();
</script>
