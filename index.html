<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kemopetrol Gig Archive</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #0b0b0c;
    color: #e0e0e0;
    margin: 0;
    padding: 20px;
  }
  h1 {
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    flex-wrap: wrap;
  }
  h1 img.logo-inline {
    height: 1em;
    vertical-align: middle;
  }
  h2 {
    text-align: center;
    font-weight: normal;
    margin-top: 4px;
  }
  .filters {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
    justify-content: center;
  }
  input, select {
    padding: 6px;
    font-size: 14px;
  }
  .table-container {
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 600px;
  }
  th, td {
    padding: 8px;
    border-bottom: 1px solid #444;
    text-align: left;
    white-space: nowrap;
  }
  th {
    background-color: #1a1a1a;
  }
  .count-info {
    margin: 10px 0;
    font-size: 14px;
    text-align: center;
  }
  .top-list-container {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 8px;
  }
  .top-list-box {
    background: #111;
    padding: 10px;
    border-radius: 8px;
  }
  .group-list {
    margin: 0;
    padding-left: 20px;
    max-height: 220px;
    overflow: auto;
  }
</style>
</head>
<body>

<h1>
  Kemopetrol
  <img src="kemopetrol_logo_optimized.png" alt="Kemopetrol logo" class="logo-inline">
</h1>
<h2>Gig Archive</h2>

<div class="filters">
  <input type="text" id="search" placeholder="Search...">
  <select id="yearFilter"><option value="">All years</option></select>
  <select id="venueFilter"><option value="">All venues / events</option></select>
  <select id="cityFilter"><option value="">All cities</option></select>
  <select id="countryFilter"><option value="">All countries</option></select>
  <select id="sortOrder">
    <option value="asc">Oldest first ▲</option>
    <option value="desc">Newest first ▼</option>
  </select>
</div>

<div class="top-list-container">
  <div class="top-list-box">
    <label for="countBy">Count by:</label>
    <select id="countBy">
      <option value="venue">Venue</option>
      <option value="city">City</option>
      <option value="country">Country</option>
    </select>
    <select id="topLimit">
      <option value="10">Top 10</option>
      <option value="25">Top 25</option>
      <option value="50">Top 50</option>
    </select>
    <ol id="topList" class="group-list"></ol>
  </div>
</div>

<div class="count-info" id="gigCount"></div>

<div class="table-container">
  <table id="gigTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Date</th>
        <th>Venue / Event</th>
        <th>City</th>
        <th>Country</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script src="gigs.js"></script>
<script>
(function(){
  const gigs = window.gigs;

  const tbody = document.querySelector('#gigTable tbody');
  const yearFilter = document.getElementById('yearFilter');
  const venueFilter = document.getElementById('venueFilter');
  const cityFilter = document.getElementById('cityFilter');
  const countryFilter = document.getElementById('countryFilter');
  const searchInput = document.getElementById('search');
  const sortOrder = document.getElementById('sortOrder');
  const gigCountEl = document.getElementById('gigCount');
  const countBySelect = document.getElementById('countBy');
  const topLimitSelect = document.getElementById('topLimit');
  const topListEl = document.getElementById('topList');

  const normalizeVenue = name => {
    return name
      .replace(/Apollo Live Club/i, "Apollo")
      .replace(/Midnight Party Planet/i, "Midnight Party Planet")
      .replace(/Provinssi.*/i, "Provinssi")
      .replace(/Kaapelitehdas.*/i, "Kaapelitehdas")
      .trim();
  };

  const years = [...new Set(gigs.map(g => g.date.split(".")[2]))].sort((a,b) => b-a);
  years.forEach(y => {
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    yearFilter.appendChild(opt);
  });

  const venues = [...new Set(gigs.map(g => normalizeVenue(g.venue)))].sort();
  venues.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    venueFilter.appendChild(opt);
  });

  const cities = [...new Set(gigs.map(g => g.city))].sort();
  cities.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    cityFilter.appendChild(opt);
  });

  const countries = [...new Set(gigs.map(g => g.country))].sort();
  countries.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    countryFilter.appendChild(opt);
  });

  function sortGigs(data) {
    return data.sort((a, b) => {
      const [da, ma, ya] = a.date.split(".");
      const [db, mb, yb] = b.date.split(".");
      const diff = new Date(`${ya}-${ma}-${da}`) - new Date(`${yb}-${mb}-${db}`);
      return sortOrder.value === 'asc' ? diff : -diff;
    });
  }

  function render() {
    const searchTerm = searchInput.value.toLowerCase();
    const yearVal = yearFilter.value;
    const venueVal = venueFilter.value;
    const cityVal = cityFilter.value;
    const countryVal = countryFilter.value;

    const filtered = gigs.filter(g => 
      (!yearVal || g.date.endsWith(yearVal)) &&
      (!venueVal || normalizeVenue(g.venue) === venueVal) &&
      (!cityVal || g.city === cityVal) &&
      (!countryVal || g.country === countryVal) &&
      (
        g.date.toLowerCase().includes(searchTerm) ||
        g.venue.toLowerCase().includes(searchTerm) ||
        g.city.toLowerCase().includes(searchTerm) ||
        g.country.toLowerCase().includes(searchTerm)
      )
    );

    const sorted = sortGigs(filtered);

    tbody.innerHTML = '';
    sorted.forEach((g, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${g.date}</td>
        <td>${g.venue}</td>
        <td>${g.city}</td>
        <td>${g.country}</td>
      `;
      tbody.appendChild(tr);
    });

    gigCountEl.textContent = `Showing ${sorted.length} gigs`;
    renderTopList(filtered);
  }

  function renderTopList(data) {
    const groupBy = countBySelect.value;
    const limit = parseInt(topLimitSelect.value, 10);

    const counts = {};
    data.forEach(g => {
      let key;
      if (groupBy === 'venue') key = normalizeVenue(g.venue);
      if (groupBy === 'city') key = g.city;
      if (groupBy === 'country') key = g.country;
      counts[key] = (counts[key] || 0) + 1;
    });

    const sortedCounts = Object.entries(counts).sort((a,b) => b[1] - a[1]);

    topListEl.innerHTML = '';
    sortedCounts.slice(0, limit).forEach(([name, count]) => {
      const li = document.createElement('li');
      li.textContent = `${name}: ${count}`;
      topListEl.appendChild(li);
    });
  }

  searchInput.addEventListener('input', render);
  yearFilter.addEventListener('change', render);
  venueFilter.addEventListener('change', render);
  cityFilter.addEventListener('change', render);
  countryFilter.addEventListener('change', render);
  sortOrder.addEventListener('change', render);
  countBySelect.addEventListener('change', () => renderTopList(gigs));
  topLimitSelect.addEventListener('change', () => renderTopList(gigs));

  render();
})();
</script>

</body>
</html>
